#!/usr/bin/env bash
set -euo pipefail

# Default parameters
POKE_CMD="pokeget random --hide-name"
FASTFETCH_CMD="fastfetch --file-raw /dev/stdin --logo-padding-left 4 --logo-padding-right 4"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --poke)
            POKE_CMD="$2"
            shift 2
            ;;
        --help|-h)
            echo "Usage: poke-fetch [--poke \"cmd\"]"
            echo "  --poke   override pokemon-colorscripts command"
            exit 0
            ;;
        *)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
    esac
done

# Check dependencies
command -v fastfetch >/dev/null 2>&1 || {
    echo "✗ fastfetch is not installed" >&2
    exit 1
}

# Extract the binary name from POKE_CMD
pokemon_cmd_binary=$(echo "$POKE_CMD" | awk '{print $1}')

# Check if the pokemon command exists
if ! command -v "$pokemon_cmd_binary" >/dev/null 2>&1; then
    echo -e "✗ $pokemon_cmd_binary is not installed, running fastfetch only" >&2
    exec fastfetch -c /usr/share/fastfetch/presets/examples/20.jsonc
fi

# Check if the pokemon command produces valid output (contains ANSI colors or is multi-line)
set +e
pokemon_output=$(eval "$POKE_CMD" 2>&1)
pokemon_exit_code=$?
set -e

if [[ $pokemon_exit_code -ne 0 ]] || [[ -z "$pokemon_output" ]] || {
    [[ "$pokemon_output" != *$'\033'* ]] && [[ "$pokemon_output" != *$'\n'* ]]
}; then
    if [[ -n "$pokemon_output" ]]; then
        echo -e "✗ pokemon command failed: $pokemon_output" >&2
    else
        echo -e "✗ pokemon command produced no output (exit code: $pokemon_exit_code)" >&2
    fi
    echo -e "Running fastfetch only" >&2
    exec fastfetch -c /usr/share/fastfetch/presets/examples/20.jsonc
fi

# Compute heights
fastfetch_height=$(fastfetch --logo none | wc -l)
pokemon_height=$(echo "$pokemon_output" | wc -l)

# Center pokemon vertically when smaller than fetch
if (( fastfetch_height > pokemon_height )); then
    padding=$(( (fastfetch_height - pokemon_height) / 2 ))
    {
        for ((i=0; i<padding; i++)); do echo; done
        echo "$pokemon_output"
    } | $FASTFETCH_CMD
else
    echo "$pokemon_output" | $FASTFETCH_CMD
fi
